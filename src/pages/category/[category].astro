---
// src/pages/category/[category].astro
import { getCollection } from 'astro:content'; // 1. Use getCollection
import BaseLayout from '../../layouts/BaseLayout.astro';
import CardFeatured from '../../components/cards/CardFeatured.astro';
import CardVertical from '../../components/cards/CardVertical.astro';
import EditorsPicks from '../../components/EditorsPicks.astro';
import CategorySidebar from '../../components/CategorySidebar.astro';

export async function getStaticPaths() {
  // 2. Fetch from the new 'blog' collection
  const allArticles = await getCollection('blog');
  const allCategories = [...new Set(allArticles.map(article => article.data.category))];

  return allCategories.map(cat => {
    const categoryArticles = allArticles.filter(article => article.data.category === cat);
    return {
      params: { category: cat.toLowerCase() },
      props: { 
        categoryName: cat,
        articles: categoryArticles 
      }
    };
  });
}

const { categoryName, articles } = Astro.props;

// 3. UPDATE LOGIC: Use '.data' instead of '.frontmatter'
const featuredArticles = articles.filter(article => article.data.isFeatured === true);
const mainGridArticles = articles.filter(article => !article.data.isFeatured);

const articlesPerPage = 9;
const mainGridPageOne = mainGridArticles.slice(0, articlesPerPage);
const showPagination = mainGridArticles.length > articlesPerPage;
---

<BaseLayout title={categoryName} activeId={categoryName.toLowerCase()}>
  <div class="container py-8 md:py-12">
    <div class="grid grid-cols-12 gap-y-32 md:gap-6">
      
      <main class="col-span-12 lg:col-span-9">
        
        <div class="mb-6 pb-4 border-b border-divider">
          <h1 class="font-merri font-bold text-2xl md:text-4xl mb-2">{categoryName}</h1>
          <p class="text-md text-muted">All posts, stories, and articles in the {categoryName} category.</p>
        </div>

        {featuredArticles.length > 0 && (
          <section class="mb-10 pb-12 border-b border-border-divider">
            <div class="flex items-center gap-2 mb-4">
              <span class="h-[18px] mb-3 w-1 bg-button-secondary"></span>
              <h2 class="font-merri font-bold text-xl text-primary">Featured</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              {featuredArticles.map(article => (
                <CardFeatured
                  href={`/blog/${article.slug}/`} 
                  imgSrc={article.data.heroImage}
                  title={article.data.title}
                  excerpt={article.data.excerpt}
                  authorName={article.data.author}
                  authorAvatar={article.data.authorAvatar}
                  date={article.data.date}
                  // views removed
                />
              ))}
            </div>
          </section>
        )}
        
        <section>
          <div class="flex items-center gap-2 mb-4">
                 <h2 class="font-merri font-bold text-xl text-primary">{categoryName} Posts</h2>
            </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {mainGridPageOne.map(article => (
              <CardVertical
                href={`/blog/${article.slug}/`}
                imgSrc={article.data.heroImage}
                category={article.data.category}
                title={article.data.title}
                date={article.data.date}
                readTime={article.readingTime}
              />
            ))}
          </div>
        </section>

        {showPagination && (
           <nav class="flex justify-center gap-2 mt-10">
             </nav>
        )}
      </main>

      <aside class="col-span-12 lg:col-span-3">
        <CategorySidebar articles={articles} />
      </aside>
    </div>
  </div>

  <div>
    <EditorsPicks />
  </div>
</BaseLayout>