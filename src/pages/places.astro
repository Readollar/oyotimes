---
// src/pages/places.astro
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import CardPlace from '../components/cards/CardPlace.astro';
import CardPlaceFeatured from '../components/cards/CardPlaceFeatured.astro';

const allPlacesFromCollection = await getCollection('places');

const allPlaces = allPlacesFromCollection.map(place => ({
  ...place.data,
  slug: place.slug,
  href: `/places/${place.slug}/`
}));

const featuredPicksData = allPlacesFromCollection.filter(p => p.data.isTopPlace === true);
const featuredPicks = featuredPicksData.map(place => ({
  ...place.data,
  href: `/places/${place.slug}/`
}));

const filterTabs = [
  { id: "all", name: "All" },
  { id: "business", name: "Businesses" },
  { id: "hotel", name: "Hotels" },
  { id: "restaurant", name: "Restaurants" },
  { id: "landmark", name: "Landmarks" },
  { id: "bar-lounge", name: "Bars & Lounges" },
];
---
<BaseLayout title="Places to Visit" activeId="places">
  
  <section class="w-full h-64 md:h-80">
    <img src="/img/hero/oyoview.jpg" alt="Popular places in Oyo" class="w-full h-full object-cover" />
  </section>

  <section class="container text-center py-8 md:py-12">
    <h1 class="font-merri font-bold text-2xl md:text-5xl text-primary">
      Discover Oyo: Businesses & Places
    </h1>
    <p class="text-lg text-muted mt-2 mb-6">
      Discover restaurants, hotels, historical sites, and hangouts across Oyo.
    </p>

    <form id="search-form" class="max-w-xl mx-auto flex rounded-lg border border-divider p-1.5 focus-within:ring-2 focus-within:ring-primary">
      <input 
        type="search" 
        id="search-input"
        placeholder="Search by name or category (e.g., hotels, businesses, restaurants, landmarks)" 
        class="w-full p-3 border-none focus:ring-0" 
      />
      <button 
        type="submit" 
        class="bg-button-default text-white font-bold py-3 px-6 rounded-md hover:bg-button-hover transition-colors"
      >
        Search
      </button>
    </form>

    <div id="filter-tabs" class="flex flex-wrap justify-center gap-3 mt-6">
      {filterTabs.map((tab, index) => (
        <button 
          data-filter={tab.id}
          class:list={[
            "filter-tab py-2 px-5 font-bold rounded-lg transition-colors border-2",
            // ✅ FIXED: Use 'bg-secondary' (Gold) for active state
            index === 0 
              ? "bg-button-secondary border-border-default text-white" 
              : "bg-white border-border-divider text-text-primary hover:border-secondary"
          ]}
        >
          {tab.name}
        </button>
      ))}
    </div>
  </section>

  <div class="container pb-8 md:pb-12">
    <div id="places-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12 md:gap-6">
      {allPlaces.map(place => (
        <div 
          data-category={place.category.toLowerCase()} 
          data-title={place.title.toLowerCase()} 
          class="place-card"
        >
          <CardPlace 
            href={place.href}
            imgSrc={place.imgSrc} 
            category={place.category}
            title={place.title}
            location={place.location}
            description={place.description}
            rating={place.rating}
            reviewCount={place.reviewCount}
            priceText={place.priceText}
            priceLabel={place.priceLabel}
          />
        </div>
      ))}
    </div>
  </div>

  <div class="container mt-20 md:mt-0 py-12 md:py-16">
    <div class="flex justify-between items-center mb-8 pb-4 border-b border-border-divider">
      <h2 class="font-merri text-2xl md:text-3xl font-bold text-text-primary">
        Editor's Picks
      </h2>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      {featuredPicks.map(pick => (
        <CardPlaceFeatured 
          href={pick.href}
          imgSrc={pick.imgSrc}
          category={pick.category}
          title={pick.title}
          location={pick.location}
          description={pick.description}
          rating={pick.rating}
          reviewCount={pick.reviewCount}
          priceText={pick.priceText}
          priceLabel={pick.priceLabel}
        />
      ))}
    </div>
  </div>

</BaseLayout>

<script>
  const filterTabs = document.querySelectorAll('.filter-tab');
  const placeCards = document.querySelectorAll('.place-card');
  const searchInput = document.getElementById('search-input');
  const searchForm = document.getElementById('search-form');
  
  function filterPlaces() {
    const query = searchInput.value.toLowerCase();
    
    // ✅ FIXED: Look for 'bg-secondary' (Gold)
    const activeTab = document.querySelector('.filter-tab.bg-button-secondary');
    const categoryFilter = activeTab ? activeTab.getAttribute('data-filter') : 'all';
    
    placeCards.forEach(card => {
      const title = card.getAttribute('data-title');
      let cardCategory = card.getAttribute('data-category');
      
      // Normalize categories for filtering
      if (cardCategory.includes('hotel')) cardCategory = 'hotel';
      else if (cardCategory.includes('restaurant')) cardCategory = 'restaurant';
      else if (cardCategory.includes('landmark')) cardCategory = 'landmark';
      else if (cardCategory.includes('lounge')) cardCategory = 'bar-lounge';
      // Add 'business' check if needed, though usually it matches exactly

      const titleMatch = title.includes(query);
      const categoryMatch = (categoryFilter === 'all' || categoryFilter === cardCategory);
      
      if (titleMatch && categoryMatch) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  }

  filterTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      filterTabs.forEach(t => {
        // ✅ FIXED: Remove 'bg-secondary'
        t.classList.remove('bg-button-secondary', 'border-secondary', 'text-white');
        t.classList.add('bg-white', 'border-border-divider', 'text-text-primary', 'hover:border-border-default');
      });
      // ✅ FIXED: Add 'bg-secondary'
      tab.classList.add('bg-button-secondary', 'border-border-divider', 'text-white');
      tab.classList.remove('bg-white', 'border-border-divider', 'text-text-primary');
      
      filterPlaces();
    });
  });

  if (searchInput) searchInput.addEventListener('keyup', filterPlaces);
  if (searchForm) searchForm.addEventListener('submit', (e) => e.preventDefault());
</script>