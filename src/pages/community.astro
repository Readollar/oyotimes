---
// src/pages/community.astro
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import CommunitySidebar from '../components/CommunitySidebar.astro';
import CardHorizontal from '../components/cards/CardHorizontal.astro';
import CardInsightGrid from '../components/cards/CardInsightGrid.astro';
import EditorsPicks from '../components/EditorsPicks.astro';

// 1. Fetch all blog posts
const allPosts = await getCollection('blog');

// 2. Filter for "Insight" category & Sort by Date
const insightPosts = allPosts
  .filter(post => post.data.category === "Insight" || post.data.category === "Community's Insight")
  .sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());

// 3. Separate "Featured" from "Main Grid"
const featuredInsights = insightPosts.filter(post => post.data.isFeatured).slice(0, 2);
const mainGridInsights = insightPosts.filter(post => !post.data.isFeatured);

// 4. Pagination Logic (Simple slice for V1)
const itemsPerPage = 9;
const currentGrid = mainGridInsights.slice(0, itemsPerPage);
const showPagination = mainGridInsights.length > itemsPerPage;
---

<BaseLayout title="Community's Insight" activeId="community">

  <div class="container py-8 md:py-12">
    <div class="grid grid-cols-12 gap-6">
      
      <main class="col-span-12 lg:col-span-9">
        
        <div class="mb-6 pb-4 border-b border-divider">
          <h1 class="font-merri font-bold text-4xl mb-2">Community's Insight</h1>
          <p class="text-lg text-muted">Voices of Oyo: Stories, ideas, and opinions from the people.</p>
        </div>

        {featuredInsights.length > 0 && (
          <section class="mb-10 pb-10 border-b border-divider">
            <h2 class="font-merri font-bold text-xl mb-4">Featured Insights</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              {featuredInsights.map(post => (
                <CardHorizontal 
                  href={`/blog/${post.slug}/`}
                  imgSrc={post.data.heroImage}
                  author={post.data.author}
                  date={post.data.date}
                  title={post.data.title}
                  excerpt={post.data.excerpt}
                />
              ))}
            </div>
          </section>
        )}

        <section>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {currentGrid.length > 0 ? (
              currentGrid.map(post => (
                <CardInsightGrid 
                  href={`/blog/${post.slug}/`}
                  imgSrc={post.data.heroImage}
                  author={post.data.author}
                  date={post.data.date}
                  title={post.data.title}
                  excerpt={post.data.excerpt}
                />
              ))
            ) : (
              !featuredInsights.length && (
                <div class="col-span-3 text-center py-12 text-muted">
                  No insights found yet. <a href="/submit" class="text-link underline">Submit one?</a>
                </div>
              )
            )}
          </div>
        </section>

        {showPagination && (
          <nav class="flex justify-center gap-2 mt-10">
            <span class="w-10 h-10 flex items-center justify-center rounded bg-primary text-white font-bold">1</span>
            </nav>
        )}

      </main>

      <aside class="col-span-12 lg:col-span-3">
        <CommunitySidebar />
      </aside>
    </div>
  </div>

  <div>
    <EditorsPicks />
  </div>

</BaseLayout>