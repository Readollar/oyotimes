---
// src/components/HeroSection.astro
// REVISED: Using correct 'text-text-primary', 'bg-button-default', etc.

import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');

// 2. GLOBAL FILTER
const coreCategories = ["Business", "Politics", "Tech", "Education", "Sports"];
const heroEligiblePosts = allPosts.filter(post => 
  coreCategories.includes(post.data.category)
);

// 3. Sort by Date
const sortedPosts = heroEligiblePosts.sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());

// --- COLUMNS LOGIC ---
const mainStory = sortedPosts.find(post => post.data.isMainStory === true) || sortedPosts[0];
const usedSlugs = [mainStory.slug];

const breakingArticles = sortedPosts.filter(p => !usedSlugs.includes(p.slug)).slice(0, 2);
breakingArticles.forEach(p => usedSlugs.push(p.slug));

const subArticles = sortedPosts.filter(p => !usedSlugs.includes(p.slug)).slice(0, 2);
subArticles.forEach(p => usedSlugs.push(p.slug));

let topStoriesRaw = [];
const categoriesToFeature = ["Business", "Sports", "Politics", "Tech", "Education"];
categoriesToFeature.forEach(cat => {
  const post = sortedPosts.find(p => p.data.category === cat && !usedSlugs.includes(p.slug));
  if (post) {
    topStoriesRaw.push(post);
    usedSlugs.push(post.slug);
  }
});

if (topStoriesRaw.length < 4) {
  const filler = sortedPosts.filter(p => !usedSlugs.includes(p.slug)).slice(0, 4 - topStoriesRaw.length);
  topStoriesRaw = [...topStoriesRaw, ...filler];
}

const topStoryHero = topStoriesRaw[0];
const topStoriesList = topStoriesRaw.slice(1);

const categoryColors = {
  Business: "bg-category-business",
  Sports: "bg-category-sports",
  Politics: "bg-category-politics",
  Tech: "bg-category-tech",
  Education: "bg-category-education",
};
---

<section class="container py-8 md:py-12">
  <div class="flex flex-col lg:grid lg:grid-cols-12 lg:gap-6 gap-8">
    
    <aside class="col-span-12 lg:col-span-3 space-y-6 lg:order-1">
      <div class="flex items-center gap-2">
        <span class="h-5 w-2 bg-background-red"></span>
        <h2 class="font-merri font-bold text-xl mb-0 text-text-primary">Breaking</h2>
      </div>

      {breakingArticles.map(article => (
        <article class="space-y-3 pb-6 border-b border-border-divider">
          <a href={`/blog/${article.slug}/`} class="group block overflow-hidden rounded-md">
            <img src={article.data.heroImage} alt={article.data.title} class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300" />
          </a>
          <div class="flex items-center gap-3 text-xs text-text-muted">
            <span class="text-background-red font-bold">
               <time class="time-ago" datetime={article.data.date} data-fallback={new Date(article.data.date).toLocaleDateString()}>
                  {new Date(article.data.date).toLocaleDateString()}
               </time>
            </span>
            <span>&bull;</span>
            <span>{article.data.author}</span>
          </div>
          <div class="space-y-1">
            <span class="text-xs font-bold uppercase text-text-link">
              {article.data.category}
            </span>
            <h3 class="font-merri font-bold text-heading-sm leading-tight text-text-primary hover:text-text-link transition-colors">
              <a href={`/blog/${article.slug}/`}>{article.data.title}</a>
            </h3>
          </div>
        </article>
      ))}
    </aside>

    <div class="col-span-12 lg:col-span-6 space-y-6 order-first lg:order-2">
      <article>
        <a href={`/blog/${mainStory.slug}/`} class="group block overflow-hidden rounded-md mb-4">
          <img src={mainStory.data.heroImage} alt={mainStory.data.title} class="w-full h-auto object-cover group-hover:scale-105 transition-transform duration-300" />
        </a>
        <div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2 text-xs text-text-muted mb-2">
          <time class="time-ago" datetime={mainStory.data.date} data-fallback={new Date(mainStory.data.date).toLocaleDateString()}>
             {new Date(mainStory.data.date).toLocaleDateString()}
          </time>
          <span>{mainStory.readingTime}</span>
          <span>{mainStory.data.author}</span>
        </div>
        <span class={`text-sm font-bold uppercase ${categoryColors[mainStory.data.category] || 'bg-gray-500'} text-white py-1 px-2 rounded-sm w-max`}>
          {mainStory.data.category}
        </span>
        <h1 class="font-merri font-bold text-heading-md leading-tight text-text-primary hover:text-text-link transition-colors mt-2">
          <a href={`/blog/${mainStory.slug}/`}>{mainStory.data.title}</a>
        </h1>
      </article>

      <div class="space-y-6">
        {subArticles.map(article => (
          <article class="pt-6 border-t border-border-divider">
            <div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2 text-xs text-text-muted mb-2">
              <time class="time-ago" datetime={article.data.date} data-fallback={new Date(article.data.date).toLocaleDateString()}>
                {new Date(article.data.date).toLocaleDateString()}
              </time>
              <span>{article.readingTime}</span>
              <span>{article.data.author}</span>
            </div>
            <h2 class="font-merri font-bold text-lg leading-tight text-text-primary hover:text-text-link transition-colors">
              <a href={`/blog/${article.slug}/`}>{article.data.title}</a>
            </h2>
          </article>
        ))}
      </div>
    </div>

    <aside class="col-span-12 lg:col-span-3 space-y-6 lg:order-3">
      <h2 class="font-merri font-bold text-xl text-text-primary bg-background-alt p-3 rounded-md">Top Stories</h2>
      
      {topStoryHero && (
        <article class="space-y-2">
          <a href={`/blog/${topStoryHero.slug}/`} class="group block overflow-hidden rounded-md">
            <img src={topStoryHero.data.heroImage} alt={topStoryHero.data.title} class="w-full h-auto object-cover group-hover:scale-105 transition-transform duration-300" />
          </a>
          <br/>
          <span class={`text-xs font-bold uppercase ${categoryColors[topStoryHero.data.category] || 'bg-gray-500'} text-white py-1 px-2 rounded-sm w-max`}>
            {topStoryHero.data.category}
          </span>
          <h3 class="font-merri font-bold text-heading-sm leading-tight text-text-primary hover:text-text-link transition-colors">
            <a href={`/blog/${topStoryHero.slug}/`}>{topStoryHero.data.title}</a>
          </h3>
          <p class="text-xs text-text-muted">
             <time class="time-ago" datetime={topStoryHero.data.date} data-fallback={new Date(topStoryHero.data.date).toLocaleDateString()}>
               {new Date(topStoryHero.data.date).toLocaleDateString()}
             </time>
          </p>
        </article>
      )}

      <ul class="space-y-4">
        {topStoriesList.map(article => (
          <li class="pt-4 border-t border-border-divider">
            <article class="space-y-1">
              <span class={`text-xs font-bold uppercase ${categoryColors[article.data.category] || 'bg-gray-500'} text-white py-1 px-2 rounded-sm w-max`}>
                {article.data.category}
              </span>
              <h4 class="font-merri font-semibold text-heading-sm leading-tight text-text-primary hover:text-text-link transition-colors">
                <a href={`/blog/${article.slug}/`}>{article.data.title}</a>
              </h4>
              <p class="text-xs text-text-muted">
                <time class="time-ago" datetime={article.data.date} data-fallback={new Date(article.data.date).toLocaleDateString()}>
                   {new Date(article.data.date).toLocaleDateString()}
                 </time>
              </p>
            </article>
          </li>
        ))}
      </ul>
    </aside>

  </div>
</section>

<script>
  import { format, formatDistanceToNow, parseISO, differenceInDays } from 'date-fns';
  const now = new Date();
  const timeElements = document.querySelectorAll('.time-ago');
  timeElements.forEach(timeEl => {
    const isoDate = timeEl.getAttribute('datetime');
    if (isoDate) {
      try {
        const date = parseISO(isoDate);
        const daysDifference = differenceInDays(now, date);
        if (daysDifference <= 7) {
          timeEl.textContent = formatDistanceToNow(date, { addSuffix: true });
        } else {
          timeEl.textContent = format(date, 'MMMM d, yyyy');
        }
      } catch (e) { }
    }
  });
</script>