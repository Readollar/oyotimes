---
// src/components/cards/CardFeatured.astro
export interface Props {
  href: string;
  imgSrc: string;
  title: string;
  excerpt: string;
  authorName: string;
  authorAvatar: string;
  date: string | Date; // ✅ Accept both String and Date object
}
const { href, imgSrc, title, excerpt, authorName, authorAvatar, date } = Astro.props;

// ✅ Helper to safely get the ISO string
const isoDate = date instanceof Date ? date.toISOString() : date;
const displayDate = isoDate.split('T')[0];

const avatarIcon = `<svg class="w-full h-full" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>`;
---

<article class="group bg-white rounded-lg shadow-soft flex flex-col h-full overflow-hidden">
  <a href={href} class="block overflow-hidden">
    <img 
      src={imgSrc} 
      alt={title} 
      class="w-full h-56 object-cover group-hover:scale-105 transition-transform duration-300"
    />
  </a>

  <div class="p-5 flex flex-col flex-grow">
    <h3 class="font-merri font-bold text-xl leading-tight text-primary group-hover:text-link transition-colors mb-2">
      <a href={href}>{title}</a>
    </h3>
    <p class="text-sm text-muted line-clamp-3 flex-grow">
      {excerpt}
    </p>
  </div>
  
  <div class="border-t border-divider p-4 flex items-center gap-3">
    <div class="w-10 h-10 rounded-full overflow-hidden bg-background-alt text-muted">
      {authorAvatar ? (
        <img src={authorAvatar} alt={authorName} class="w-full h-full object-cover" />
      ) : (
        <Fragment set:html={avatarIcon} />
      )}
    </div>
    <div class="flex-1">
      <div class="font-bold text-sm text-primary">{authorName}</div>
      <div class="text-xs text-muted">
        <time class="time-ago" datetime={isoDate} data-fallback={displayDate}>
          {displayDate}
        </time>
      </div>
    </div>
  </div>
</article>

<script>
  import { formatDistanceToNow, parseISO, differenceInDays } from 'date-fns';

  const timeElements = document.querySelectorAll('.time-ago');

  timeElements.forEach(timeEl => {
    const rawDate = timeEl.getAttribute('datetime');
    if (!rawDate) return;

    try {
      // Try to create a Date object
      let date = new Date(rawDate);
      
      // Check if date is valid
      if (isNaN(date.getTime())) {
         throw new Error("Invalid Date");
      }

      const now = new Date();
      const daysDifference = differenceInDays(now, date);

      if (daysDifference <= 7) {
        timeEl.textContent = formatDistanceToNow(date, { addSuffix: true });
      } else {
        // Format as "August 8, 2025"
        timeEl.textContent = date.toLocaleDateString('en-US', {
           year: 'numeric', month: 'long', day: 'numeric'
        });
      }
    } catch (e) {
      console.error("Date error:", e);
      // It will just keep the fallback text which is fine
    }
  });
</script>