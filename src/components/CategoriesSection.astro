---
// src/components/CategoriesSection.astro
// REVISED: Now fully dynamic using Content Collections

import { getCollection } from 'astro:content';

// 1. Fetch all blog posts
const allPosts = await getCollection('blog');

// 2. Sort by Date (Newest First)
const sortedPosts = allPosts.sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());

// 3. Define the categories we want to show
const categoryNames = ["Business", "Sports", "Politics", "Tech"];

// 4. Build the dynamic data for each category
const categoriesData = categoryNames.map(catName => {
  // Filter posts for this category
  const catPosts = sortedPosts.filter(p => p.data.category === catName);
  
  // If no posts, return null (we'll filter these out later)
  if (catPosts.length === 0) return null;

  return {
    name: catName,
    // Map category name to your color classes
    categoryClass: `bg-category-${catName.toLowerCase()}`, 
    // First post is Main
    mainArticle: catPosts[0],
    // Next 3 are Sub-articles
    subArticles: catPosts.slice(1, 4)
  };
}).filter(Boolean); // Remove nulls (empty categories)

// SVG Icon
const calendarIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`;
---

<section class="container py-8 md:py-12">
  <div class="grid grid-cols-12 gap-6">
    
    {categoriesData.map(category => (
      <div class="col-span-12 md:col-span-6 lg:col-span-3 space-y-5">
        
        <h2 class="font-merri text-xl font-bold text-primary border-b border-divider pb-2">
          {category.name}
        </h2>

        <article class="group">
          <a href={`/blog/${category.mainArticle.slug}/`} class="block overflow-hidden rounded-lg mb-4 shadow-soft">
            <img 
              src={category.mainArticle.data.heroImage} 
              alt={category.mainArticle.data.title} 
              class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
            />
          </a>
          <div class="space-y-2">
            <span class={`text-xs font-bold uppercase ${category.categoryClass || 'bg-gray-500'} text-white py-1 px-2 rounded-sm w-max`}>
              {category.name}
            </span>
            <h3 class="font-merri font-bold text-heading-sm leading-tight text-primary group-hover:text-link transition-colors">
              <a href={`/blog/${category.mainArticle.slug}/`}>{category.mainArticle.data.title}</a>
            </h3>
            <div class="flex items-center gap-1.5 text-sm text-muted">
              <Fragment set:html={calendarIcon} />
              {new Date(category.mainArticle.data.date).toLocaleDateString()}
            </div>
          </div>
        </article>

        <ul class="space-y-4">
          {category.subArticles.map(article => (
            <li class="space-y-2">
              <span class={`text-xs font-bold uppercase ${category.categoryClass || 'bg-gray-500'} text-white py-1 px-2 rounded-sm w-max`}>
                {category.name}
              </span>
              <h4 class="font-merri font-semibold text-heading-sm leading-tight text-primary hover:text-link transition-colors">
                <a href={`/blog/${article.slug}/`}>{article.data.title}</a>
              </h4>
              <div class="flex items-center gap-1.5 text-sm text-muted">
                <Fragment set:html={calendarIcon} />
                {new Date(article.data.date).toLocaleDateString()}
              </div>
            </li>
          ))}
        </ul>

        <a href={`/category/${category.name.toLowerCase()}`} class="inline-block text-sm font-bold text-link hover:underline">
          READ MORE &rarr;
        </a>
      </div>
    ))}

  </div>
</section>